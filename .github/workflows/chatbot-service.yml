name: Chatbot Service - CI/CD Pipeline

on:
  push:
    branches:
      - develop
      - staging
      - main
      - feat/ci-cd
      - 'feature/**'
    paths:
      - 'backend/chatbot-service/**'
      - '.github/workflows/chatbot-service.yml'
      - '.github/workflows/lint-python.yml'
      - '.github/workflows/test-python.yml'
      - '.github/workflows/build-python.yml'
  pull_request:
    branches:
      - develop
      - staging
      - main
    paths:
      - 'backend/chatbot-service/**'
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (staging|production)"
        required: true
        default: "staging"
      image_tag:
        description: "Image tag to deploy (optional)"
        required: false

# Permissions required by the reusable `build-python.yml` workflow
permissions:
  contents: read
  packages: write

# Prevent overlapping deploys to the same environment 
concurrency:
  group: chatbot-service-${{ github.event_name == 'workflow_dispatch' && inputs.environment || (github.ref_name == 'main' && 'production' || 'staging') }}
  cancel-in-progress: true

jobs:
  # ================================
  # CI JOBS
  # ================================
  
  lint:
    name: Lint Python Code
    uses: ./.github/workflows/lint-python.yml
    with:
      service-path: backend/chatbot-service
      python-version: '3.11'

  tests:
    name: Run Tests
    uses: ./.github/workflows/test-python.yml
    needs: lint
    with:
      service-path: backend/chatbot-service
      python-version: '3.11'

  build:
    name: Build Docker Image
    uses: ./.github/workflows/build-python.yml
    needs: tests
    with:
      service-path: backend/chatbot-service
      service-name: chatbot-service

  # ================================
  # CD JOBS
  # ================================
  
  deploy:
    name: Deploy to Kubernetes
    # Deploy only for staging/main branches or manual workflow_dispatch
    if: |
      needs.build.result == 'success' &&
      (github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'push' && (github.ref_name == 'staging' || github.ref_name == 'main')))
    needs: [lint, tests, build]
    uses: ./.github/workflows/deploy-k8s.yml
    with:
      service-name: chatbot-service
      k8s-manifests-path: k8s/chatbot-service
      namespace: shopifake-prod
      deployments: chatbot-service,qdrant
    secrets:
      KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
