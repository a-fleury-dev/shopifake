.PHONY: help build up down restart logs clean rebuild dev-up dev-down dev-restart

help: ## Afficher cette aide
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

build: ## Compiler les services
	docker-compose build

up: ## DÃ©marrer tous les services
	docker-compose up -d

down: ## ArrÃªter tous les services
	docker-compose down

restart: ## RedÃ©marrer tous les services
	docker-compose restart

logs: ## Afficher les logs de tous les services
	docker-compose logs -f

logs-main: ## Afficher les logs de main-api
	docker-compose logs -f main-api

logs-image: ## Afficher les logs de image-service
	docker-compose logs -f image-service

clean: ## ArrÃªter et supprimer les volumes
	docker-compose down -v

rebuild: ## Rebuild et redÃ©marrer tous les services
	docker-compose down
	docker-compose build --no-cache
	docker-compose up -d

dev-up: ## DÃ©marrer l'environnement de dÃ©veloppement
	@echo "ğŸš€ DÃ©marrage de l'environnement de dÃ©veloppement..."
	docker-compose up -d postgres-main postgres-image minio
	@echo "â³ Attente du dÃ©marrage des bases de donnÃ©es..."
	@sleep 10
	@echo "âœ… Environnement de dÃ©veloppement prÃªt!"
	@echo "ğŸ“Š PostgreSQL Main API : localhost:5432"
	@echo "ğŸ“Š PostgreSQL Image Service : localhost:5555"
	@echo "ğŸ—‚ï¸  MinIO Console : http://localhost:9001 (minioadmin/minioadmin)"
	@echo "ğŸ—‚ï¸  MinIO API : http://localhost:9000"

dev-down: ## ArrÃªter l'environnement de dÃ©veloppement
	docker-compose down

dev-restart: ## RedÃ©marrer l'environnement de dÃ©veloppement
	docker-compose restart postgres-main postgres-image minio

dev: dev-up ## Alias pour dev-up

dev-main-chatbot: ## DÃ©marrer l'environnement pour main-api + chatbot (PostgreSQL, Qdrant)
	@echo "ğŸš€ DÃ©marrage de l'environnement main-api + chatbot..."
	docker-compose up -d postgres-main postgres-image minio qdrant
	@echo "â³ Attente du dÃ©marrage des services..."
	@sleep 10
	@echo "âœ… Environnement prÃªt!"
	@echo "ğŸ“Š PostgreSQL Main API : localhost:5432"
	@echo "ğŸ“Š PostgreSQL Image Service : localhost:5555"
	@echo "ğŸ—‚ï¸  MinIO Console : http://localhost:9001 (minioadmin/minioadmin)"
	@echo "ğŸ—‚ï¸  MinIO API : http://localhost:9000"
	@echo "ğŸ” Qdrant API : http://localhost:6333"
	@echo "ğŸ” Qdrant UI : http://localhost:6334/dashboard"
	@echo ""
	@echo "Pour lancer les services applicatifs:"
	@echo "  - Main API: cd main-api && mvn spring-boot:run"
	@echo "  - Chatbot: make chatbot-up"

full-up: ## DÃ©marrer tous les services (DB + applications)
	@echo "ğŸš€ DÃ©marrage de tous les services..."
	docker-compose up -d
	@echo "âœ… Tous les services sont dÃ©marrÃ©s!"
	@echo "ğŸŒ Main API : http://localhost:5001"
	@echo "ğŸŒ Image Service : http://localhost:5002"
	@echo "ğŸ“Š PostgreSQL Main API : localhost:5432"
	@echo "ğŸ“Š PostgreSQL Image Service : localhost:5555"
	@echo "ğŸ—‚ï¸  MinIO Console : http://localhost:9001"

status: ## Afficher le status de tous les services
	docker-compose ps

ps: status ## Alias pour status

# Python Services
chatbot-setup: ## CrÃ©er l'environnement virtuel et installer les dÃ©pendances du chatbot
	@echo "ğŸ”§ Configuration de l'environnement chatbot..."
	@cd chatbot-service && python3 -m venv venv
	@cd chatbot-service && . venv/bin/activate && pip install -r requirements.txt
	@echo "âœ… Environnement chatbot prÃªt!"

chatbot-up: ## DÃ©marrer le service chatbot (FastAPI)
	@echo "ğŸ¤– DÃ©marrage du chatbot service..."
	@cd chatbot-service && . venv/bin/activate && uvicorn main:app --reload --port 8000

recommandation-setup: ## CrÃ©er l'environnement virtuel et installer les dÃ©pendances de recommandation
	@echo "ğŸ”§ Configuration de l'environnement recommandation..."
	@cd recommandation-service && python3 -m venv venv
	@cd recommandation-service && . venv/bin/activate && pip install -r requirements.txt
	@echo "âœ… Environnement recommandation prÃªt!"

recommandation-up: ## DÃ©marrer le service de recommandation (FastAPI)
	@echo "ğŸ¯ DÃ©marrage du recommandation service..."
	@cd recommandation-service && . venv/bin/activate && uvicorn app.main:app --reload --port 8001

